#cloud-config
# K3s Cluster Cloud-Init Configuration
# Generated by Terraform for K3s HA cluster deployment
# Hostname is dynamically set via Terraform templatefile()

package_update: true
package_upgrade: false
locale: en_US.UTF-8
timezone: Europe/Berlin

# German keyboard layout configuration
keyboard:
  layout: de
  variant: ''

# Create ansible user with sudo privileges
users:
  - name: ansible
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDIDQZk48Wi1T+bAnWBUa22c2yhION4hY3rHGwi6c7COdZw+uTxWq03Kdu+J6xzj7ikbyIG3ifBPjgO2fwzveteTRc0U8uIRy9k7N+Y9C9WnLp8+T7ustePoqN6rqbOR7fZIFVFP+iiEAh29RtBkh+tTsNDxxJ29hxO1axS8xxdAon8zLVJZZP8ikAI6hwNUQEBsq8JgJR1ViVSUHolFLLYdtGK/GT9fWG9RlVgwiF7hjB/D4eylL+nZkNCFZWjtOklY4D8tpthV1n6MVEEVv93aof2YvH6Mgx7kZPZNwvzWaijbxAGbxPIiASfi+x2iF7Xbab9LituFBSa35uhymQ0dOfBnvLcSR4tkphW5hQ9GtFPeEusLnunjJH84sAzE9ySDw25NlrjKyNegubHRsIjPHt0YysCx/ZbrmgGeYuR8Ch7x27FU7jUZh4qxRrwy24CMpMrQ+QQZetUg9LoOeAuC9mqGd8C7GLGfsXksqM3Db1XrzSBR2sQ+sYO/NSGIo9UyvBf30PzPAZARN3FjUor+y0ffPmJzrs0CgW/TcYxEjTvBA78WQQ/LKEWAm/bmJilwqGk1XzRFOwYwhjfkEw/0TQuiMOtYObz3Q5YMHVRSKM5mQlPpRw1uAB8nIUGwfWjr+ykPjd+ZGP9/tWhzDydhfRBUzt/sbTBpvUK0pR5gw== thorsten@hornung-bn.de

# SSH Configuration - Enable root access with key for Ansible
ssh_pwauth: false
disable_root: false

write_files:
  - path: /etc/apt/apt.conf.d/01proxy
    content: |
      Acquire::http::Proxy "http://apt-cacher.hornung-bn.de:3142";
    owner: root:root
    permissions: '0644'
  - path: /etc/default/keyboard
    content: |
      XKBMODEL="pc105"
      XKBLAYOUT="de"
      XKBVARIANT=""
      XKBOPTIONS=""
      BACKSPACE="guess"
    owner: root:root
    permissions: '0644'
  # DNS Search Domain Fix - Prevent .de suffix expansion
  # Critical: Prevents ha.hornung-bn.de -> ha.hornung-bn.de.de resolution bug
  # GitOps: This config is applied on every VM deployment automatically
  - path: /etc/systemd/resolved.conf
    content: |
      # Managed by Cloud-Init - DNS Search Domain Fix
      # Prevents Kubernetes pods from inheriting .de search domain

      [Resolve]
      # Pi-hole DNS servers (local resolution)
      DNS=192.168.2.4 192.168.4.5 192.168.4.6

      # Fallback DNS (internet access if Pi-hole fails)
      FallbackDNS=8.8.8.8 1.1.1.1

      # CRITICAL: NO search domains to prevent .de suffix expansion
      # Empty Domains= prevents ha.hornung-bn.de -> ha.hornung-bn.de.de
      Domains=

      # DNSSEC validation disabled (Pi-hole handles this)
      DNSSEC=no

      # Use stub resolver on 127.0.0.53 (default)
      DNSStubListener=yes

      # Cache DNS responses (improved performance)
      Cache=yes

      # Read /etc/hosts for local overrides
      ReadEtcHosts=yes
    owner: root:root
    permissions: '0644'
  # Systemd service to enforce empty DNS domain on every boot
  # Prevents systemd-resolved from inferring domain from FQDN
  - path: /etc/systemd/system/clear-dns-domain.service
    content: |
      [Unit]
      Description=Clear DNS search domain to prevent .de suffix bug
      After=network.target systemd-resolved.service
      Before=kubelet.service k3s.service

      [Service]
      Type=oneshot
      ExecStart=/bin/bash -c 'for iface in $(ls /sys/class/net | grep -E "^eth|^ens"); do resolvectl domain $iface "" || true; done'
      ExecStart=/bin/systemctl restart systemd-resolved
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target
    owner: root:root
    permissions: '0644'

packages:
  - qemu-guest-agent
  - keyboard-configuration
  - console-setup

runcmd:
  - echo "Starting K3s cloud-init configuration for ${vm_hostname}"
  # APT Lock Prevention - prevents conflicts during K3s installation
  # Integrated from cloud-init-apt-fix.yml for CI/CD consistency
  - systemctl disable --now unattended-upgrades || true
  - systemctl disable --now apt-daily.timer || true
  - systemctl disable --now apt-daily-upgrade.timer || true
  - systemctl mask unattended-upgrades || true
  - echo "APT automatic updates disabled to prevent lock conflicts"
  - apt-get update
  - localectl set-keymap de
  - localectl set-x11-keymap de
  - setupcon
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  - echo "✅ qemu-guest-agent enabled and started"
  # DNS Search Domain Fix - Apply systemd-resolved config and boot-time enforcement
  - systemctl daemon-reload
  - systemctl enable clear-dns-domain.service
  - systemctl start clear-dns-domain.service
  - echo "✅ DNS domain clear service enabled (persistent across reboots)"
  - echo "✅ systemd-resolved configured (NO .de search domain)"
  - resolvectl status | grep -i "DNS Domain" || echo "✅ No DNS search domains (correct!)"
  - systemctl enable --now ssh
  - echo "✅ SSH service enabled and started"
  - echo "✅ apt-cacher proxy configured (apt-cacher.hornung-bn.de:3142)"
  - echo "✅ German keyboard layout configured"
  - echo "✅ Hostname set to ${vm_hostname}.hornung-bn.de"
  - echo "K3s cloud-init configuration complete for ${vm_hostname}"
  - logger -t cloud-init "K3s node ${vm_hostname} initialization complete"

# Set hostname properly for cluster - rendered by Terraform
preserve_hostname: false
manage_etc_hosts: true
fqdn: ${vm_hostname}.hornung-bn.de
hostname: ${vm_hostname}
