#cloud-config
# Swarmpit LXC Container Cloud-Init Configuration
# Purpose: Docker host with Swarmpit management stack
# Features: Docker CE, ulimits for CouchDB, network configuration
# Hostname is set via Terraform templatefile variable: ${vm_hostname}

package_update: true
package_upgrade: false
locale: en_US.UTF-8
timezone: Europe/Berlin

hostname: ${vm_hostname}
fqdn: ${vm_hostname}.hornung-bn.de
manage_etc_hosts: true

keyboard:
  layout: de
  variant: ''

users:
  - name: ansible
    groups: sudo, docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHDiYk2/cmfKjky19j+RQCDjNK1r0xd8VYi4VpR6tX/P thorsten@hornung-bn.de

ssh_authorized_keys:
  - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIHDiYk2/cmfKjky19j+RQCDjNK1r0xd8VYi4VpR6tX/P thorsten@hornung-bn.de

ssh_pwauth: false
disable_root: false

write_files:
  # APT Proxy Configuration
  - path: /etc/apt/apt.conf.d/01proxy
    content: |
      Acquire::http::Proxy "http://apt-cacher.hornung-bn.de:3142";
    owner: root:root
    permissions: '0644'

  # German Keyboard Configuration
  - path: /etc/default/keyboard
    content: |
      XKBMODEL="pc105"
      XKBLAYOUT="de"
      XKBVARIANT=""
      XKBOPTIONS=""
      BACKSPACE="guess"
    owner: root:root
    permissions: '0644'

  # Ulimits for CouchDB (CRITICAL!)
  # CouchDB requires high file descriptor limits for view building
  - path: /etc/security/limits.d/99-docker-couchdb.conf
    content: |
      # CouchDB requires high ulimits for view building
      couchdb soft nofile 65536
      couchdb hard nofile 65536
      # General Docker container limits
      * soft nofile 65536
      * hard nofile 65536
      * soft nproc 4096
      * hard nproc 65536
      root soft nofile 65536
      root hard nofile 65536
    owner: root:root
    permissions: '0644'

  # Docker daemon configuration
  - path: /etc/docker/daemon.json
    content: |
      {
        "log-driver": "json-file",
        "log-opts": {
          "max-size": "50m",
          "max-file": "3"
        },
        "storage-driver": "overlay2",
        "default-ulimits": {
          "nofile": {
            "Name": "nofile",
            "Hard": 65536,
            "Soft": 65536
          }
        },
        "default-address-pools": [
          {"base": "172.20.0.0/16", "size": 24}
        ]
      }
    owner: root:root
    permissions: '0644'

  # Sysctl settings for Docker networking and CouchDB
  - path: /etc/sysctl.d/99-docker-couchdb.conf
    content: |
      # Docker networking
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1
      net.ipv4.conf.all.forwarding = 1
      # CouchDB performance tuning
      net.core.somaxconn = 262144
      net.ipv4.tcp_max_syn_backlog = 262144
      net.core.netdev_max_backlog = 5000
      # Disable swap for CouchDB
      vm.swappiness = 0
      vm.max_map_count = 262144
    owner: root:root
    permissions: '0644'

  # Remote Syslog to Loki/Promtail
  - path: /etc/rsyslog.d/60-loki.conf
    content: |
      # Forward all logs to Loki/Promtail syslog receiver
      *.* @@loki.hornung-bn.de:1514
      *.* @loki.hornung-bn.de:1514
    owner: root:root
    permissions: '0644'

  # Swarm Manager IP for joining
  - path: /etc/swarm-manager
    content: |
      SWARM_MANAGER_IP=${swarm_manager_ip}
    owner: root:root
    permissions: '0644'

packages:
  - curl
  - wget
  - gnupg
  - ca-certificates
  - apt-transport-https
  - software-properties-common
  - jq
  - htop
  - iotop
  - net-tools

runcmd:
  # Configure keyboard
  - setupcon --save-only
  - loadkeys de || true

  # Install Docker CE from official Ubuntu repository
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  - chmod a+r /etc/apt/keyrings/docker.asc
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" > /etc/apt/sources.list.d/docker.list
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

  # Configure Docker
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker ansible

  # Apply sysctl settings
  - sysctl --system

  # Configure remote syslog to Loki
  - systemctl restart rsyslog

  # Signal cloud-init completion
  - echo "Cloud-init completed for ${vm_hostname}" > /var/log/cloud-init-complete.log
  - echo "Swarm Manager IP: ${swarm_manager_ip}" >> /var/log/cloud-init-complete.log

final_message: "Swarmpit container ${vm_hostname} ready after $UPTIME seconds. Run Ansible to join Swarm and deploy Swarmpit."
