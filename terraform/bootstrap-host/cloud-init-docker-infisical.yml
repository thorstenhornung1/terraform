#cloud-config
# Bootstrap Host Cloud-Init Configuration
# Purpose: Fully automated Docker host for Infisical secrets management
# Deployed OUTSIDE K3s cluster to avoid circular dependencies
# Features: LDAP/SSSD integration, automated secret generation, zero manual steps

package_update: true
package_upgrade: false
locale: en_US.UTF-8
timezone: Europe/Berlin

# German keyboard layout configuration
keyboard:
  layout: de
  variant: ''

# Create ansible user with sudo privileges
users:
  - name: ansible
    groups: sudo, docker
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDIDQZk48Wi1T+bAnWBUa22c2yhION4hY3rHGwi6c7COdZw+uTxWq03Kdu+J6xzj7ikbyIG3ifBPjgO2fwzveteTRc0U8uIRy9k7N+Y9C9WnLp8+T7ustePoqN6rqbOR7fZIFVFP+iiEAh29RtBkh+tTsNDxxJ29hxO1axS8xxdAon8zLVJZZP8ikAI6hwNUQEBsq8JgJR1ViVSUHolFLLYdtGK/GT9fWG9RlVgwiF7hjB/D4eylL+nZkNCFZWjtOklY4D8tpthV1n6MVEEVv93aof2YvH6Mgx7kZPZNwvzWaijbxAGbxPIiASfi+x2iF7Xbab9LituFBSa35uhymQ0dOfBnvLcSR4tkphW5hQ9GtFPeEusLnunjJH84sAzE9ySDw25NlrjKyNegubHRsIjPHt0YysCx/ZbrmgGeYuR8Ch7x27FU7jUZh4qxRrwy24CMpMrQ+QQZetUg9LoOeAuC9mqGd8C7GLGfsXksqM3Db1XrzSBR2sQ+sYO/NSGIo9UyvBf30PzPAZARN3FjUor+y0ffPmJzrs0CgW/TcYxEjTvBA78WQQ/LKEWAm/bmJilwqGk1XzRFOwYwhjfkEw/0TQuiMOtYObz3Q5YMHVRSKM5mQlPpRw1uAB8nIUGwfWjr+ykPjd+ZGP9/tWhzDydhfRBUzt/sbTBpvUK0pR5gw== thorsten@hornung-bn.de

# Enable root SSH access with same key (CRITICAL - required for all VMs)
ssh_authorized_keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDIDQZk48Wi1T+bAnWBUa22c2yhION4hY3rHGwi6c7COdZw+uTxWq03Kdu+J6xzj7ikbyIG3ifBPjgO2fwzveteTRc0U8uIRy9k7N+Y9C9WnLp8+T7ustePoqN6rqbOR7fZIFVFP+iiEAh29RtBkh+tTsNDxxJ29hxO1axS8xxdAon8zLVJZZP8ikAI6hwNUQEBsq8JgJR1ViVSUHolFLLYdtGK/GT9fWG9RlVgwiF7hjB/D4eylL+nZkNCFZWjtOklY4D8tpthV1n6MVEEVv93aof2YvH6Mgx7kZPZNwvzWaijbxAGbxPIiASfi+x2iF7Xbab9LituFBSa35uhymQ0dOfBnvLcSR4tkphW5hQ9GtFPeEusLnunjJH84sAzE9ySDw25NlrjKyNegubHRsIjPHt0YysCx/ZbrmgGeYuR8Ch7x27FU7jUZh4qxRrwy24CMpMrQ+QQZetUg9LoOeAuC9mqGd8C7GLGfsXksqM3Db1XrzSBR2sQ+sYO/NSGIo9UyvBf30PzPAZARN3FjUor+y0ffPmJzrs0CgW/TcYxEjTvBA78WQQ/LKEWAm/bmJilwqGk1XzRFOwYwhjfkEw/0TQuiMOtYObz3Q5YMHVRSKM5mQlPpRw1uAB8nIUGwfWjr+ykPjd+ZGP9/tWhzDydhfRBUzt/sbTBpvUK0pR5gw== thorsten@hornung-bn.de

ssh_pwauth: false
disable_root: false

write_files:
  # APT Proxy Configuration
  - path: /etc/apt/apt.conf.d/01proxy
    content: |
      Acquire::http::Proxy "http://apt-cacher.hornung-bn.de:3142";
    owner: root:root
    permissions: '0644'

  # Keyboard Configuration
  - path: /etc/default/keyboard
    content: |
      XKBMODEL="pc105"
      XKBLAYOUT="de"
      XKBVARIANT=""
      XKBOPTIONS=""
      BACKSPACE="guess"
    owner: root:root
    permissions: '0644'

  # SSSD Configuration for LDAP Integration
  - path: /etc/sssd/sssd.conf
    content: |
      [sssd]
      domains = default
      config_file_version = 2
      services = nss, pam

      [domain/default]
      # LDAP Provider Configuration
      id_provider = ldap
      auth_provider = ldap
      ldap_uri = ldap://ldap.hornung-bn.de
      ldap_search_base = dc=ldap,dc=hornung-bn,dc=de
      ldap_default_bind_dn = uid=root,cn=users,dc=ldap,dc=hornung-bn,dc=de
      ldap_default_authtok = |v9TV8%I)6aJ[^8!X=VI

      # TLS Configuration (relaxed for internal use)
      ldap_tls_reqcert = never

      # Caching and Performance
      cache_credentials = true
      enumerate = true
      entry_cache_timeout = 300
      entry_cache_user_timeout = 300
      entry_cache_group_timeout = 300

      # UID/GID Mapping for Consistency
      ldap_id_mapping = false
      ldap_user_uid_number = uidNumber
      ldap_user_gid_number = gidNumber
      ldap_group_gid_number = gidNumber

      # User and Group Search Configuration
      ldap_user_search_base = cn=users,dc=ldap,dc=hornung-bn,dc=de
      ldap_group_search_base = cn=groups,dc=ldap,dc=hornung-bn,dc=de

      # Home Directory Configuration
      override_homedir = /home/%u
      default_shell = /bin/bash
      fallback_homedir = /home/%u

      # Authentication Configuration
      ldap_pwd_policy = none

      # Debug Level (reduce in production)
      debug_level = 0x0070
    owner: root:root
    permissions: '0600'

  # Docker Compose Stack for Infisical + Traefik (PostgreSQL Production)
  - path: /opt/infisical/docker-compose.yml
    content: |
      version: '3.8'

      networks:
        infisical:
          driver: bridge

      services:
        # Traefik Reverse Proxy with Let's Encrypt
        traefik:
          image: traefik:v2.11
          container_name: traefik
          restart: unless-stopped
          networks:
            - infisical
          ports:
            - "80:80"
            - "443:443"
          volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
            - /opt/infisical/traefik:/etc/traefik
            - /opt/infisical/letsencrypt:/letsencrypt
          command:
            - --api.dashboard=true
            - --api.insecure=false
            - --providers.docker=true
            - --providers.docker.exposedbydefault=false
            - --providers.docker.network=infisical_infisical
            - --entrypoints.web.address=:80
            - --entrypoints.websecure.address=:443
            - --entrypoints.web.http.redirections.entryPoint.to=websecure
            - --entrypoints.web.http.redirections.entryPoint.scheme=https
            - --certificatesresolvers.letsencrypt.acme.email=thorsten@hornung-bn.de
            - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
            - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
            - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
            - --log.level=DEBUG
          labels:
            - "traefik.enable=true"
            - "traefik.http.routers.traefik.rule=Host(`traefik.hornung-bn.de`)"
            - "traefik.http.routers.traefik.entrypoints=websecure"
            - "traefik.http.routers.traefik.tls.certresolver=letsencrypt"
            - "traefik.http.routers.traefik.service=api@internal"

        # PostgreSQL Database
        postgres:
          image: postgres:15-alpine
          container_name: postgres
          restart: unless-stopped
          networks:
            - infisical
          environment:
            - POSTGRES_DB=$${POSTGRES_DB}
            - POSTGRES_USER=$${POSTGRES_USER}
            - POSTGRES_PASSWORD=$${POSTGRES_PASSWORD}
          volumes:
            - /opt/infisical/postgres-data:/var/lib/postgresql/data
          healthcheck:
            test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 30s

        # Redis for Infisical session management
        redis:
          image: redis:7-alpine
          container_name: redis
          restart: unless-stopped
          command: redis-server --save 60 1 --loglevel warning
          volumes:
            - /opt/infisical/redis-data:/data
          networks:
            - infisical
          healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 3s
            retries: 5

        # Infisical Secrets Management (PostgreSQL + Redis)
        infisical:
          image: infisical/infisical:v0.46.0-postgres
          container_name: infisical
          restart: unless-stopped
          depends_on:
            postgres:
              condition: service_healthy
            redis:
              condition: service_healthy
            traefik:
              condition: service_started
          networks:
            - infisical
          environment:
            - ENCRYPTION_KEY=$${INFISICAL_ENCRYPTION_KEY}
            - JWT_SECRET=$${INFISICAL_JWT_SECRET}
            - AUTH_SECRET=$${AUTH_SECRET}
            - DB_CONNECTION_URI=postgres://$${POSTGRES_USER}:$${POSTGRES_PASSWORD}@postgres:5432/$${POSTGRES_DB}
            - REDIS_URL=redis://redis:6379
            - SITE_URL=https://infisical.hornung-bn.de
            - HTTPS_ENABLED=true
            - TELEMETRY_ENABLED=false
          healthcheck:
            disable: true
          labels:
            - "traefik.enable=true"
            - "traefik.http.routers.infisical.rule=Host(`infisical.hornung-bn.de`)"
            - "traefik.http.routers.infisical.entrypoints=websecure"
            - "traefik.http.routers.infisical.tls.certresolver=letsencrypt"
            - "traefik.http.services.infisical.loadbalancer.server.port=8080"

        # Promtail Log Aggregation
        promtail:
          image: grafana/promtail:latest
          container_name: promtail
          restart: unless-stopped
          networks:
            - infisical
          volumes:
            - /opt/infisical/promtail-config.yml:/etc/promtail/config.yml:ro
            - /var/log:/var/log:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
          command: -config.file=/etc/promtail/config.yml
    owner: root:root
    permissions: '0644'

  # Environment variables for Infisical (PLACEHOLDER - will be auto-generated)
  - path: /opt/infisical/.env.template
    content: |
      # Infisical Secrets - AUTO-GENERATED during cloud-init
      # DO NOT EDIT - Generated with: openssl rand -hex 32

      # Infisical Core Secrets
      INFISICAL_ENCRYPTION_KEY=WILL_BE_REPLACED_BY_CLOUD_INIT
      INFISICAL_JWT_SECRET=WILL_BE_REPLACED_BY_CLOUD_INIT
      AUTH_SECRET=WILL_BE_REPLACED_BY_CLOUD_INIT

      # PostgreSQL Configuration
      POSTGRES_DB=infisical
      POSTGRES_USER=infisical
      POSTGRES_PASSWORD=WILL_BE_REPLACED_BY_CLOUD_INIT
    owner: root:root
    permissions: '0600'

  # Backup script for PostgreSQL database
  - path: /opt/infisical/backup.sh
    content: |
      #!/bin/bash
      # Infisical PostgreSQL Backup Script
      set -euo pipefail

      BACKUP_DIR="/opt/infisical/backups"
      TIMESTAMP=$(date +%Y%m%d_%H%M%S)
      BACKUP_FILE="$BACKUP_DIR/infisical_postgres_$TIMESTAMP.sql"

      mkdir -p "$BACKUP_DIR"

      # Source environment variables
      source /opt/infisical/.env

      # Dump PostgreSQL database
      docker exec postgres pg_dump -U "$POSTGRES_USER" -d "$POSTGRES_DB" > "$BACKUP_FILE"

      # Compress backup
      gzip "$BACKUP_FILE"

      # Keep last 30 backups
      find "$BACKUP_DIR" -name "infisical_postgres_*.sql.gz" -mtime +30 -delete

      echo "Backup completed: $${BACKUP_FILE}.gz"
      ls -lh "$${BACKUP_FILE}.gz"
    owner: root:root
    permissions: '0755'

  # Systemd service for Infisical stack
  - path: /etc/systemd/system/infisical.service
    content: |
      [Unit]
      Description=Infisical Secrets Management Stack
      Requires=docker.service
      After=docker.service

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      WorkingDirectory=/opt/infisical
      ExecStart=/usr/bin/docker-compose up -d
      ExecStop=/usr/bin/docker-compose down

      [Install]
      WantedBy=multi-user.target
    owner: root:root
    permissions: '0644'

  # Daily backup cron job
  - path: /etc/cron.d/infisical-backup
    content: |
      # Daily Infisical SQLite backup at 2 AM
      0 2 * * * root /opt/infisical/backup.sh >> /var/log/infisical-backup.log 2>&1
    owner: root:root
    permissions: '0644'

  # Promtail configuration for Loki log aggregation
  - path: /opt/infisical/promtail-config.yml
    content: |
      server:
        http_listen_port: 9080
        grpc_listen_port: 0

      positions:
        filename: /tmp/positions.yaml

      clients:
        - url: http://loki.hornung-bn.de:3100/loki/api/v1/push

      scrape_configs:
        # Docker container logs
        - job_name: docker
          docker_sd_configs:
            - host: unix:///var/run/docker.sock
              refresh_interval: 5s
          relabel_configs:
            - source_labels: ['__meta_docker_container_name']
              regex: '/(.*)'
              target_label: 'container'
            - source_labels: ['__meta_docker_container_log_stream']
              target_label: 'stream'
          pipeline_stages:
            - docker: {}

        # System logs
        - job_name: system
          static_configs:
            - targets:
                - localhost
              labels:
                job: varlogs
                host: ${vm_hostname}
                __path__: /var/log/*.log

        # Cloud-init logs
        - job_name: cloud-init
          static_configs:
            - targets:
                - localhost
              labels:
                job: cloud-init
                host: ${vm_hostname}
                __path__: /var/log/cloud-init*.log

        # Infisical backup logs
        - job_name: infisical-backup
          static_configs:
            - targets:
                - localhost
              labels:
                job: infisical-backup
                host: ${vm_hostname}
                __path__: /var/log/infisical-backup.log
    owner: root:root
    permissions: '0644'

  # Secret generation script
  - path: /usr/local/bin/generate-infisical-secrets.sh
    content: |
      #!/bin/bash
      # Auto-generate Infisical secrets and start service
      set -e

      echo "=== Generating Infisical Secrets ==="

      # Generate secure random secrets
      # CRITICAL: Infisical requires 128-bit (16 byte) ENCRYPTION_KEY, NOT 256-bit!
      # See: https://infisical.com/docs/self-hosting/configuration/envars
      ENCRYPTION_KEY=$(openssl rand -hex 16)
      JWT_SECRET=$(openssl rand -hex 32)
      AUTH_SECRET=$(openssl rand -hex 32)
      POSTGRES_PASSWORD=$(openssl rand -hex 32)

      # Create .env file with generated secrets
      cat > /opt/infisical/.env <<EOF
      # Infisical Secrets - AUTO-GENERATED on $(date)
      # Generated with: openssl rand -hex 32

      # Infisical Core Secrets
      INFISICAL_ENCRYPTION_KEY=$ENCRYPTION_KEY
      INFISICAL_JWT_SECRET=$JWT_SECRET
      AUTH_SECRET=$AUTH_SECRET

      # PostgreSQL Configuration
      POSTGRES_DB=infisical
      POSTGRES_USER=infisical
      POSTGRES_PASSWORD=$POSTGRES_PASSWORD
      EOF

      chmod 600 /opt/infisical/.env
      echo "âœ… Infisical secrets generated and saved to /opt/infisical/.env"

      # Start Infisical service
      echo "=== Starting Infisical Service ==="
      systemctl daemon-reload
      systemctl enable infisical.service
      systemctl start infisical.service

      # Wait for services to be ready (PostgreSQL + Redis need time to start)
      echo "Waiting for PostgreSQL and Redis to be healthy..."
      sleep 30

      # Check service status
      echo "=== Service Status ==="
      docker-compose -f /opt/infisical/docker-compose.yml ps

      echo ""
      echo "âœ… Infisical stack deployed successfully"
      echo "ðŸŒ Access Infisical at: https://infisical.hornung-bn.de"
      echo "ðŸŒ Traefik dashboard at: https://traefik.hornung-bn.de"
      echo ""
      echo "ðŸ“‹ Services running:"
      echo "  - PostgreSQL 15 (database)"
      echo "  - Redis 7 (session management)"
      echo "  - Infisical v0.46.0 (secrets management)"
      echo "  - Traefik v2.11 (reverse proxy + Let's Encrypt)"
      echo "  - Promtail (log aggregation)"
    owner: root:root
    permissions: '0755'

packages:
  - qemu-guest-agent
  - keyboard-configuration
  - console-setup
  - apt-transport-https
  - ca-certificates
  - curl
  - gnupg
  - lsb-release

runcmd:
  - 'echo "=== Starting Bootstrap Host cloud-init configuration for ${vm_hostname} ==="'
  - 'logger -t cloud-init "Bootstrap host ${vm_hostname} initialization started"'

  # ============================================================================
  # PHASE 1: APT Lock Prevention
  # ============================================================================
  - 'echo "=== PHASE 1: APT Lock Prevention ==="'
  - systemctl disable --now unattended-upgrades || true
  - systemctl disable --now apt-daily.timer || true
  - systemctl disable --now apt-daily-upgrade.timer || true
  - systemctl mask unattended-upgrades || true
  - 'echo "âœ… APT automatic updates disabled"'

  # ============================================================================
  # PHASE 2: Keyboard Configuration
  # ============================================================================
  - 'echo "=== PHASE 2: Keyboard Configuration ==="'
  - apt-get update
  - localectl set-keymap de
  - localectl set-x11-keymap de
  - setupcon
  - 'echo "âœ… German keyboard layout configured"'

  # ============================================================================
  # PHASE 3: QEMU Guest Agent
  # ============================================================================
  - 'echo "=== PHASE 3: QEMU Guest Agent ==="'
  - systemctl enable qemu-guest-agent
  - systemctl start qemu-guest-agent
  - 'echo "âœ… qemu-guest-agent enabled and started"'

  # ============================================================================
  # PHASE 4: LDAP/SSSD Package Installation
  # ============================================================================
  - 'echo "=== PHASE 4: LDAP/SSSD Package Installation ==="'
  - |
    # Pre-seed debconf to avoid interactive prompts
    echo "ldap-auth-config ldap-auth-config/ldapns/ldap-server string ldap://ldap.hornung-bn.de" | debconf-set-selections
    echo "ldap-auth-config ldap-auth-config/ldapns/base-dn string dc=ldap,dc=hornung-bn,dc=de" | debconf-set-selections
    echo "ldap-auth-config ldap-auth-config/ldapns/ldap_version select 3" | debconf-set-selections
    echo "ldap-auth-config ldap-auth-config/dbrootlogin boolean true" | debconf-set-selections
    echo "ldap-auth-config ldap-auth-config/dblogin boolean false" | debconf-set-selections
    echo "ldap-auth-config ldap-auth-config/rootbinddn string uid=root,cn=users,dc=ldap,dc=hornung-bn,dc=de" | debconf-set-selections
    echo "ldap-auth-config ldap-auth-config/rootbindpw password |v9TV8%I)6aJ[^8!X=VI" | debconf-set-selections
    echo "ldap-auth-config ldap-auth-config/move-to-debconf boolean true" | debconf-set-selections
    echo "âœ… Debconf pre-seeded for LDAP packages"

    # Clean any stale locks
    pkill -9 -f "apt-get|aptitude|dpkg|unattended-upgrade" >/dev/null 2>&1 || true
    rm -f /var/lib/dpkg/lock-frontend /var/lib/dpkg/lock /var/cache/apt/archives/lock || true
    dpkg --configure -a || true

    # Install LDAP packages with retry (non-interactive)
    RETRY_COUNT=0
    MAX_RETRIES=5
    while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
      if DEBIAN_FRONTEND=noninteractive apt-get install -y -qq sssd libnss-ldap libpam-ldap ldap-utils sssd-tools libnss-sss libpam-sss; then
        echo "âœ… LDAP packages installed successfully"
        break
      else
        RETRY_COUNT=$((RETRY_COUNT + 1))
        echo "âš ï¸  LDAP package installation failed (attempt $RETRY_COUNT/$MAX_RETRIES)"
        if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
          sleep 15
          pkill -9 -f "apt-get|dpkg" || true
          rm -f /var/lib/dpkg/lock* /var/cache/apt/archives/lock || true
          dpkg --configure -a || true
        fi
      fi
    done

    if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
      echo "âŒ LDAP package installation failed after $MAX_RETRIES attempts"
      logger -t cloud-init "ERROR: LDAP package installation failed"
    fi

  # ============================================================================
  # PHASE 5: SSSD Configuration
  # ============================================================================
  - 'echo "=== PHASE 5: SSSD Configuration ==="'
  - systemctl stop sssd || true
  - rm -rf /var/lib/sss/db/* || true
  - mkdir -p /var/log/sssd
  - chmod 600 /etc/sssd/sssd.conf
  - 'echo "âœ… SSSD configuration prepared"'

  # ============================================================================
  # PHASE 6: NSS Configuration
  # ============================================================================
  - 'echo "=== PHASE 6: NSS Configuration ==="'
  - |
    # Configure NSS to use SSSD
    sed -i 's/^passwd:.*/passwd:         files sss/' /etc/nsswitch.conf
    sed -i 's/^group:.*/group:          files sss/' /etc/nsswitch.conf
    sed -i 's/^shadow:.*/shadow:         files sss/' /etc/nsswitch.conf
    echo "âœ… NSS configured for SSSD"

  # ============================================================================
  # PHASE 7: PAM Configuration
  # ============================================================================
  - 'echo "=== PHASE 7: PAM Configuration ==="'
  - |
    # Configure PAM for home directory creation
    if ! grep -q "pam_mkhomedir.so" /etc/pam.d/common-session; then
      echo "session required pam_mkhomedir.so skel=/etc/skel umask=077" >> /etc/pam.d/common-session
    fi

    # Configure PAM for SSSD authentication
    if ! grep -q "pam_sss.so" /etc/pam.d/common-auth; then
      sed -i '/^auth.*pam_unix.so/a auth sufficient pam_sss.so use_first_pass' /etc/pam.d/common-auth
    fi

    echo "âœ… PAM configured for SSSD and auto home directory creation"

  # ============================================================================
  # PHASE 8: Login Configuration
  # ============================================================================
  - 'echo "=== PHASE 8: Login Configuration ==="'
  - |
    # Enable automatic home directory creation
    sed -i 's/^CREATE_HOME.*/CREATE_HOME yes/' /etc/login.defs || echo "CREATE_HOME yes" >> /etc/login.defs

    # Set consistent UID/GID ranges for local users
    sed -i 's/^UID_MIN.*/UID_MIN 5000/' /etc/login.defs
    sed -i 's/^UID_MAX.*/UID_MAX 59999/' /etc/login.defs
    sed -i 's/^GID_MIN.*/GID_MIN 5000/' /etc/login.defs
    sed -i 's/^GID_MAX.*/GID_MAX 59999/' /etc/login.defs

    echo "âœ… Login configuration updated"

  # ============================================================================
  # PHASE 9: Enable SSSD Service
  # ============================================================================
  - 'echo "=== PHASE 9: Enable SSSD Service ==="'
  - systemctl daemon-reload
  - systemctl enable sssd
  - systemctl start sssd
  - sleep 10
  - 'echo "âœ… SSSD service started"'

  # ============================================================================
  # PHASE 10: LDAP Connectivity Test
  # ============================================================================
  - 'echo "=== PHASE 10: LDAP Connectivity Test ==="'
  - |
    if ldapsearch -x -H ldap://ldap.hornung-bn.de -D "uid=root,cn=users,dc=ldap,dc=hornung-bn,dc=de" -w "|v9TV8%I)6aJ[^8!X=VI" -b "dc=ldap,dc=hornung-bn,dc=de" "(objectClass=*)" dn | head -5; then
      echo "âœ… LDAP connection successful"
      logger -t cloud-init "LDAP connection successful"
    else
      echo "âš ï¸  LDAP connection test failed - check network and credentials"
      logger -t cloud-init "WARNING: LDAP connection test failed"
    fi

  # ============================================================================
  # PHASE 11: SSSD User Enumeration Test
  # ============================================================================
  - 'echo "=== PHASE 11: SSSD User Enumeration Test ==="'
  - |
    USER_COUNT=$(getent passwd | grep -v "^[^:]*:[^:]*:[0-4][0-9][0-9][0-9]:" | wc -l || echo "0")
    if [ "$USER_COUNT" -gt 0 ]; then
      echo "âœ… LDAP users visible via NSS ($USER_COUNT users found)"
      logger -t cloud-init "SSSD integration successful - $USER_COUNT LDAP users visible"
    else
      echo "âš ï¸  No LDAP users visible - check SSSD configuration"
      logger -t cloud-init "WARNING: No LDAP users visible via NSS"
    fi

  # ============================================================================
  # PHASE 12: Docker Installation
  # ============================================================================
  - 'echo "=== PHASE 12: Docker Installation ==="'
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  - chmod a+r /etc/apt/keyrings/docker.asc
  - 'echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null'
  - apt-get update
  - apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  - systemctl enable docker
  - systemctl start docker
  - 'echo "âœ… Docker installed and started"'

  # ============================================================================
  # PHASE 13: Docker Compose Installation
  # ============================================================================
  - 'echo "=== PHASE 13: Docker Compose Installation ==="'
  - curl -SL https://github.com/docker/compose/releases/download/v2.24.0/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose
  - chmod +x /usr/local/bin/docker-compose
  - ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
  - docker-compose --version
  - 'echo "âœ… Docker Compose installed"'

  # ============================================================================
  # PHASE 14: Infisical Directory Structure
  # ============================================================================
  - 'echo "=== PHASE 14: Infisical Directory Structure ==="'
  - mkdir -p /opt/infisical/{postgres-data,redis-data,backups,traefik,letsencrypt}
  - chmod 700 /opt/infisical/postgres-data
  - chmod 700 /opt/infisical/redis-data
  - chmod 700 /opt/infisical/letsencrypt
  - 'echo "âœ… Directory structure created (PostgreSQL + Redis)"'

  # ============================================================================
  # PHASE 15: Generate Infisical Secrets & Start Service
  # ============================================================================
  - 'echo "=== PHASE 15: Generate Infisical Secrets & Start Service ==="'
  - /usr/local/bin/generate-infisical-secrets.sh
  - 'logger -t cloud-init "Infisical secrets auto-generated and service started"'

  # ============================================================================
  # PHASE 16: Final Verification
  # ============================================================================
  - 'echo "=== PHASE 16: Final Verification ==="'
  - |
    echo "=== Bootstrap Host Deployment Summary ==="
    echo "Hostname: ${vm_hostname}.hornung-bn.de"
    echo "LDAP Integration: $(systemctl is-active sssd)"
    echo "Docker: $(systemctl is-active docker)"
    echo "Infisical Stack: $(systemctl is-active infisical.service)"
    echo ""
    echo "=== Container Status ==="
    docker-compose -f /opt/infisical/docker-compose.yml ps
    echo ""
    echo "=== Access URLs ==="
    echo "ðŸŒ Infisical: https://infisical.hornung-bn.de"
    echo "ðŸŒ Traefik Dashboard: https://traefik.hornung-bn.de"
    echo ""
    echo "=== Logging Configuration ==="
    echo "Promtail: $(docker inspect promtail --format='{{.State.Status}}' 2>/dev/null || echo 'not running')"
    echo "Loki Endpoint: http://loki.hornung-bn.de:3100"
    echo "APT Cache Proxy: apt-cacher.hornung-bn.de:3142"
    echo ""
    echo "=== LDAP Users (first 5) ==="
    getent passwd | grep -v "^[^:]*:[^:]*:[0-4][0-9][0-9][0-9]:" | head -5 || echo "No LDAP users found"
    echo ""
    echo "âœ… Bootstrap host cloud-init configuration COMPLETE"

  - 'logger -t cloud-init "Bootstrap host ${vm_hostname} initialization COMPLETE"'

# Set hostname properly
preserve_hostname: false
manage_etc_hosts: true
fqdn: ${vm_hostname}.hornung-bn.de
hostname: ${vm_hostname}
