# =============================================================================
# Proxmox VM Firewall Configuration for Docker Swarm Cluster
# =============================================================================
# Configures per-VM firewall rules on Proxmox to restrict network access.
# Processes one VM at a time (serial: 1) to prevent cluster-wide lockout.
#
# Usage (API token - recommended):
#   PROXMOX_API_TOKEN_ID=user@pam!tokenname \
#   PROXMOX_API_TOKEN_SECRET=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx \
#   ansible-playbook -i ansible/inventory.ini playbooks/configure-proxmox-firewall.yml
#
# Usage (password auth - alternative):
#   PROXMOX_API_PASSWORD=password \
#   ansible-playbook -i ansible/inventory.ini playbooks/configure-proxmox-firewall.yml
#
# Rollback (disable firewall on all VMs):
#   ansible-playbook -i ansible/inventory.ini playbooks/configure-proxmox-firewall.yml \
#     --extra-vars "firewall_enabled=false"
#
# Or manually per-VM:
#   pvesh set /nodes/<node>/qemu/<vmid>/firewall/options --enable 0
# =============================================================================
---
- name: Configure Proxmox Firewall for Docker Swarm VMs
  hosts: localhost
  connection: local
  gather_facts: false
  serial: 1

  vars:
    proxmox_api_host: "pve01.hornung-bn.de"
    proxmox_api_user: "root@pam"
    # Auth method 1: API token (preferred)
    proxmox_api_token_id: "{{ lookup('env', 'PROXMOX_API_TOKEN_ID') }}"
    proxmox_api_token_secret: "{{ lookup('env', 'PROXMOX_API_TOKEN_SECRET') }}"
    # Auth method 2: Password (fallback)
    proxmox_api_password: "{{ lookup('env', 'PROXMOX_API_PASSWORD') }}"
    # Use token auth if token is set, otherwise password
    use_token_auth: "{{ proxmox_api_token_id | length > 0 }}"
    firewall_enabled: true

    # -------------------------------------------------------------------------
    # VM Definitions
    # -------------------------------------------------------------------------
    infra_nodes:
      - vmid: 4200
        node: pve01
        name: docker-infra-1
      - vmid: 4201
        node: pve02
        name: docker-infra-2
      - vmid: 4202
        node: pve03
        name: docker-infra-3

    # -------------------------------------------------------------------------
    # Firewall Rules - Common (applied to ALL nodes)
    # -------------------------------------------------------------------------
    common_rules:
      # SSH from management VLAN
      - type: in
        action: ACCEPT
        source: "192.168.2.0/24"
        dport: "22"
        proto: tcp
        comment: "SSH from management VLAN 2"
        pos: 0

      # Home Assistant -> HAProxy RW
      - type: in
        action: ACCEPT
        source: "192.168.2.5"
        dport: "5433"
        proto: tcp
        comment: "Home Assistant -> HAProxy PostgreSQL RW"
        pos: 1

      # Home Assistant -> HAProxy RO
      - type: in
        action: ACCEPT
        source: "192.168.2.5"
        dport: "5434"
        proto: tcp
        comment: "Home Assistant -> HAProxy PostgreSQL RO"
        pos: 2

      # Traefik HTTP (VLAN 4 - web traffic)
      - type: in
        action: ACCEPT
        dport: "80"
        proto: tcp
        comment: "Traefik HTTP ingress"
        pos: 3

      # Traefik HTTPS (VLAN 4 - web traffic)
      - type: in
        action: ACCEPT
        dport: "443"
        proto: tcp
        comment: "Traefik HTTPS ingress"
        pos: 4

      # Docker Swarm management (VLAN 4)
      - type: in
        action: ACCEPT
        source: "192.168.4.0/24"
        dport: "2377"
        proto: tcp
        comment: "Swarm management VLAN 4"
        pos: 5

      # Docker Swarm gossip TCP (VLAN 4)
      - type: in
        action: ACCEPT
        source: "192.168.4.0/24"
        dport: "7946"
        proto: tcp
        comment: "Swarm gossip TCP VLAN 4"
        pos: 6

      # Docker Swarm gossip UDP (VLAN 4)
      - type: in
        action: ACCEPT
        source: "192.168.4.0/24"
        dport: "7946"
        proto: udp
        comment: "Swarm gossip UDP VLAN 4"
        pos: 7

      # Docker Swarm VXLAN (VLAN 4)
      - type: in
        action: ACCEPT
        source: "192.168.4.0/24"
        dport: "4789"
        proto: udp
        comment: "Swarm VXLAN VLAN 4"
        pos: 8

      # Docker Swarm gossip TCP (VLAN 12)
      - type: in
        action: ACCEPT
        source: "192.168.12.0/24"
        dport: "7946"
        proto: tcp
        comment: "Swarm gossip TCP VLAN 12"
        pos: 9

      # Docker Swarm gossip UDP (VLAN 12)
      - type: in
        action: ACCEPT
        source: "192.168.12.0/24"
        dport: "7946"
        proto: udp
        comment: "Swarm gossip UDP VLAN 12"
        pos: 10

      # Docker Swarm VXLAN (VLAN 12)
      - type: in
        action: ACCEPT
        source: "192.168.12.0/24"
        dport: "4789"
        proto: udp
        comment: "Swarm VXLAN VLAN 12"
        pos: 11

    # -------------------------------------------------------------------------
    # Firewall Rules - Infra-only (PostgreSQL, Patroni, etcd)
    # -------------------------------------------------------------------------
    infra_extra_rules:
      # PostgreSQL direct (HAProxy + replication via VLAN 12)
      - type: in
        action: ACCEPT
        source: "192.168.12.0/24"
        dport: "5432"
        proto: tcp
        comment: "PostgreSQL direct VLAN 12"
        pos: 12

      # Patroni REST API (HAProxy health checks via VLAN 12)
      - type: in
        action: ACCEPT
        source: "192.168.12.0/24"
        dport: "8008"
        proto: tcp
        comment: "Patroni REST API VLAN 12"
        pos: 13

      # etcd client port (VLAN 12)
      - type: in
        action: ACCEPT
        source: "192.168.12.0/24"
        dport: "2379"
        proto: tcp
        comment: "etcd client VLAN 12"
        pos: 14

      # etcd peer port (VLAN 12)
      - type: in
        action: ACCEPT
        source: "192.168.12.0/24"
        dport: "2380"
        proto: tcp
        comment: "etcd peer VLAN 12"
        pos: 15

      # Prometheus exporter (VLAN 4 for monitoring)
      - type: in
        action: ACCEPT
        source: "192.168.4.0/24"
        dport: "9187"
        proto: tcp
        comment: "Postgres exporter metrics VLAN 4"
        pos: 16

  tasks:
    # =========================================================================
    # Step 1: Authenticate to Proxmox API
    # =========================================================================

    # --- Token auth (preferred) ---
    - name: Set auth headers (API token)
      ansible.builtin.set_fact:
        pve_auth_headers:
          Authorization: "PVEAPIToken={{ proxmox_api_token_id }}={{ proxmox_api_token_secret }}"
      no_log: true
      when: use_token_auth | bool

    # --- Password auth (fallback) ---
    - name: Authenticate to Proxmox API (password)
      ansible.builtin.uri:
        url: "https://{{ proxmox_api_host }}:8006/api2/json/access/ticket"
        method: POST
        body_format: form-urlencoded
        body:
          username: "{{ proxmox_api_user }}"
          password: "{{ proxmox_api_password }}"
        validate_certs: false
      register: proxmox_auth
      no_log: true
      when: not (use_token_auth | bool)

    - name: Set auth headers (password ticket)
      ansible.builtin.set_fact:
        pve_auth_headers:
          Cookie: "PVEAuthCookie={{ proxmox_auth.json.data.ticket }}"
          CSRFPreventionToken: "{{ proxmox_auth.json.data.CSRFPreventionToken }}"
      no_log: true
      when: not (use_token_auth | bool)

    # =========================================================================
    # Step 2: Configure Infra Nodes (Swarm Managers + Patroni)
    # =========================================================================
    - name: Configure firewall for infra nodes
      ansible.builtin.include_tasks: tasks/configure-vm-firewall.yml
      loop: "{{ infra_nodes }}"
      loop_control:
        loop_var: vm
        label: "{{ vm.name }} (VMID {{ vm.vmid }})"
      vars:
        fw_rules: "{{ common_rules + infra_extra_rules }}"
