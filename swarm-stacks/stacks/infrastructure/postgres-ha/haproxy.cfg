# =============================================================================
# HAProxy Configuration for Patroni PostgreSQL Cluster
# =============================================================================
# Automatically routes connections to the current Patroni leader or replicas
# using HTTP health checks against the Patroni REST API (port 8008).
#
# Ports:
#   5433 - Primary (read-write) → current Patroni leader
#   5434 - Replicas (read-only) → Patroni standbys
#   7000 - Stats dashboard (HTTP)
# =============================================================================

global
    maxconn 2000
    log stdout format raw local0 info

defaults
    mode tcp
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    log global
    default-server inter 3s fall 3 rise 2 maxconn 100

# =============================================================================
# Primary (Read-Write) - Port 5433
# =============================================================================
# Routes to the current Patroni leader.
# Health check: GET /primary returns 200 only on the leader node.
# on-marked-down shutdown-sessions: immediately disconnect clients when a
# primary is demoted so they reconnect to the new leader.

listen postgres_primary
    bind *:5433
    option httpchk GET /primary
    http-check expect status 200
    server postgres-1 192.168.12.40:5432 check port 8008 on-marked-down shutdown-sessions
    server postgres-2 192.168.12.41:5432 check port 8008 on-marked-down shutdown-sessions
    server postgres-3 192.168.12.42:5432 check port 8008 on-marked-down shutdown-sessions

# =============================================================================
# Replicas (Read-Only) - Port 5434
# =============================================================================
# Routes to Patroni replicas for read scaling.
# Health check: GET /replica returns 200 only on standby nodes.

listen postgres_replicas
    bind *:5434
    option httpchk GET /replica
    http-check expect status 200
    server postgres-1 192.168.12.40:5432 check port 8008
    server postgres-2 192.168.12.41:5432 check port 8008
    server postgres-3 192.168.12.42:5432 check port 8008

# =============================================================================
# Stats Dashboard - Port 7000
# =============================================================================

listen stats
    bind *:7000
    mode http
    stats enable
    stats uri /
    stats refresh 10s
